<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Lift Log</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for clean text, Space Mono for futuristic mono-spaced elements -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Meta tag for theme color for mobile browsers -->
    <meta name="theme-color" content="#0d1117">
    <style>
        /* Custom Styles for Futuristic Dark Theme and Enhanced UI */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* GitHub Dark Theme background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            padding: 1.5rem; /* Increased padding */
            color: #c9d1d9; /* Default light gray text */
        }
        #app-container {
            background-color: #161b22; /* Slightly lighter dark background for main container */
            border-radius: 1rem; /* Slightly less rounded for a sharper look */
            box-shadow: 0 15px 30px rgba(0, 255, 255, 0.1), 0 5px 15px rgba(0, 255, 255, 0.05); /* Subtle cyan glow */
            max-width: 520px; /* Slightly wider */
            width: 100%;
            padding: 2rem; /* Increased padding */
            display: flex;
            flex-direction: column;
            gap: 2rem; /* Increased gap between sections */
            margin-top: 3rem; /* More margin from top */
            margin-bottom: 3rem; /* More margin from bottom */
            border: 1px solid #30363d; /* Subtle border */
        }
        input[type="text"],
        select {
            border-radius: 0.5rem; /* Sharper corners for inputs */
            padding: 0.85rem 1.2rem; /* Slightly more padding */
            border: 1px solid #30363d; /* Darker border for inputs */
            font-size: 1rem;
            background-color: #0d1117; /* Deep dark background for inputs */
            color: #c9d1d9; /* Light text for inputs */
            outline: none;
            flex-grow: 1;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3); /* Inner shadow for depth */
            -webkit-appearance: none; /* For iOS Safari */
            -moz-appearance: none; /* For Firefox */
            appearance: none; /* Standard property */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="text"]:focus,
        select:focus {
            border-color: #00bcd4; /* Cyan highlight on focus */
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.3), inset 0 1px 3px rgba(0, 0, 0, 0.3); /* Cyan glow + inner shadow */
        }
        input[type="text"]::placeholder {
            color: #8b949e; /* Muted placeholder text */
        }

        /* Native Select Arrow Customization (for futuristic look) */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%238b949e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2em;
            padding-right: 2.5rem; /* Make space for the custom arrow */
        }
        select:focus {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%2300bcd4' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        button {
            border-radius: 0.5rem; /* Sharper corners */
            padding: 0.85rem 1.2rem;
            font-weight: 700; /* Bolder text */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Deeper shadow */
            letter-spacing: 0.05em; /* Slightly spaced letters */
        }
        button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.6); /* Even deeper shadow */
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        /* Primary button - vibrant gradient */
        .primary-button {
            background: linear-gradient(45deg, #00bcd4, #536dfe); /* Cyan to Indigo gradient */
            color: #ffffff;
            border: none;
        }
        .primary-button:hover {
            background: linear-gradient(45deg, #00acc1, #4252cc); /* Slightly darker gradient on hover */
        }
        /* Delete button - subtle red */
        .delete-button {
            background-color: #2a0b0b; /* Very dark red */
            color: #ef4444; /* Red text */
            padding: 0.4rem 0.6rem; /* Smaller padding for icon button */
            border-radius: 0.375rem; /* Slightly rounded */
            box-shadow: none; /* No extra shadow */
            border: 1px solid #4a0f0f; /* Darker red border */
        }
        .delete-button:hover {
            background-color: #3b0f0f; /* Darker red on hover */
            transform: translateY(-1px);
            color: #f87171; /* Lighter red on hover */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Section backgrounds - unified dark tones */
        .section-card {
            background-color: #161b22; /* Same as app container for consistency */
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.05); /* Inner cyan glow */
            border: 1px solid #30363d;
        }

        /* Message Box Styles */
        #messageBox {
            background-color: #1e2a3a; /* Dark blue-gray for messages */
            color: #e0f2f7; /* Light blue text */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #00bcd4; /* Cyan border */
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            min-width: 280px;
            text-align: center;
            padding: 1rem;
            border-radius: 0.75rem;
            font-family: 'Space Mono', monospace; /* Futuristic font for messages */
        }
        #messageBox.show {
            opacity: 1;
            visibility: visible;
        }
        /* Specific message box types (colors adjusted for dark mode) */
        #messageBox.error { background-color: #4a1c1c !important; color: #fca5a5 !important; border-color: #ef4444 !important; } /* Dark red, light red text, red border */
        #messageBox.success { background-color: #1c4a1c !important; color: #a7f3d0 !important; border-color: #10b981 !important; } /* Dark green, light green text, green border */
        #messageBox.info { background-color: #1c2a4a !important; color: #93c5fd !important; border-color: #3b82f6 !important; } /* Dark blue, light blue text, blue border */

        /* Header Specifics */
        .header-title {
            font-family: 'Space Mono', monospace; /* Futuristic font for title */
            font-size: 3.5rem; /* Larger title */
            letter-spacing: -0.05em; /* Tighter letter spacing */
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        .user-id-text {
            font-family: 'Space Mono', monospace; /* Futuristic font for user ID */
            color: #8b949e; /* Muted gray */
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Workout Item Styling */
        .workout-item {
            background-color: #0d1117; /* Deep dark for individual items */
            border-radius: 0.5rem;
            padding: 1rem 1.25rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }
        .workout-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.15); /* Subtle cyan hover glow */
        }
        .workout-name {
            font-weight: 600;
            color: #e6edf3; /* Lighter text for name */
            font-size: 1.1rem;
        }
        .workout-details {
            color: #8b949e; /* Muted gray for details */
            font-size: 0.9rem;
            font-family: 'Space Mono', monospace;
        }
        .category-heading {
            font-family: 'Space Mono', monospace;
            color: #00bcd4; /* Cyan for category headings */
            font-size: 1.75rem; /* Larger category headings */
            border-bottom: 1px solid #30363d;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
            letter-spacing: 0.02em;
        }
    </style>
    <!-- Firebase SDK CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and data
        let app;
        let db;
        let auth;
        let userId = null; // Will be set after authentication
        let workouts = []; // Array to hold workout data
        const categories = ['chest', 'tricep', 'bicep', 'back', 'shoulder', 'other'];

        // UI Elements (declared globally, assigned in window.onload)
        let newWorkoutNameInput;
        let newWorkoutWeightRepsInput;
        let newWorkoutCategorySelect;
        let addWorkoutButton;
        let workoutsListContainer;
        let userIdDisplay;
        let messageBox;

        // Firebase configuration (from your previous prompt)
        const firebaseConfig = {
            apiKey: "AIzaSyBigbr7vwxrPtkNRGZfUMn77It86h92G-k",
            authDomain: "workout-log-33537.firebaseapp.com",
            projectId: "workout-log-33537", // This will be our 'appId' for Firestore paths
            storageBucket: "workout-log-33537.firebasestorage.app",
            messagingSenderId: "614677399114",
            appId: "1:614677399114:web:d5ad21c1031b430a0a88b3",
            measurementId: "G-NWH23G9N14"
        };

        /**
         * Displays a message box with a given message and type.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message (for styling).
         * @param {number} duration - How long to show the message in milliseconds.
         */
        function showMessage(message, type = 'info', duration = 3000) {
            if (!messageBox) {
                console.error("Message box element not found.");
                // Fallback to console log if messageBox isn't available
                console.log(`Message (${type}): ${message}`);
                return;
            }

            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`; // Apply type class for styling

            setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.className = 'message-box'; // Reset classes after hiding
            }, duration);
        }

        /**
         * Renders the workouts to the DOM, grouped by category.
         */
        function renderWorkouts() {
            if (!workoutsListContainer) {
                console.error("Workouts list container not found.");
                return;
            }

            // Clear existing content
            workoutsListContainer.innerHTML = '';

            if (workouts.length === 0) {
                workoutsListContainer.innerHTML = '<p class="text-gray-400 text-center text-sm">No workouts logged yet. Your journey begins here.</p>';
                return;
            }

            // Group workouts by category for display
            const groupedWorkouts = categories.reduce((acc, category) => {
                acc[category] = workouts.filter(workout => workout.category === category);
                return acc;
            }, {});

            categories.forEach(category => {
                if (groupedWorkouts[category].length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'mb-6';
                    categoryDiv.innerHTML = `
                        <h3 class="category-heading capitalize">${category}</h3>
                        <ul class="space-y-3" id="ul-${category}"></ul>
                    `;
                    workoutsListContainer.appendChild(categoryDiv);

                    const ulElement = document.getElementById(`ul-${category}`);
                    groupedWorkouts[category].forEach(workout => {
                        const listItem = document.createElement('li');
                        listItem.className = 'flex items-center justify-between workout-item';
                        listItem.innerHTML = `
                            <div>
                                <p class="workout-name">${workout.name}</p>
                                <p class="workout-details">${workout.weightReps}</p>
                            </div>
                            <button class="delete-button" data-id="${workout.id}" aria-label="Delete workout">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
                                </svg>
                            </button>
                        `;
                        ulElement.appendChild(listItem);

                        // Attach event listener to the delete button
                        listItem.querySelector('.delete-button').addEventListener('click', (e) => {
                            const workoutId = e.currentTarget.dataset.id;
                            deleteWorkout(workoutId);
                        });
                    });
                }
            });
        }

        /**
         * Listens for real-time updates to workout data in Firestore.
         */
        function listenForWorkouts() {
            if (!db || !userId) {
                console.warn("Firestore db or userId not initialized. Cannot listen for workouts.");
                return;
            }

            const appIdForFirestore = firebaseConfig.projectId; // Use projectId as appId
            const workoutsCollectionRef = collection(db, `artifacts/${appIdForFirestore}/users/${userId}/workouts`);
            const q = query(workoutsCollectionRef);

            onSnapshot(q, (snapshot) => {
                const fetchedWorkouts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Sort workouts client-side by category and then by name
                fetchedWorkouts.sort((a, b) => {
                    const categoryOrder = ['chest', 'tricep', 'bicep', 'back', 'shoulder', 'other'];
                    const categoryA = categoryOrder.indexOf(a.category);
                    const categoryB = categoryOrder.indexOf(b.category);

                    if (categoryA !== categoryB) {
                        return categoryA - categoryB;
                    }
                    return a.name.localeCompare(b.name);
                });
                workouts = fetchedWorkouts; // Update the global workouts array
                renderWorkouts(); // Re-render the UI
                console.log("Workouts updated from Firestore.");
            }, (error) => {
                console.error("Error fetching workouts:", error);
                showMessage("Error loading workouts. Please check your connection.", 'error');
            });
        }

        /**
         * Adds a new workout entry to Firestore.
         */
        async function addWorkout() {
            const name = newWorkoutNameInput.value.trim();
            const weightReps = newWorkoutWeightRepsInput.value.trim();
            const category = newWorkoutCategorySelect.value;

            if (!name || !weightReps || !category) {
                showMessage("Please fill all fields: Workout Name, Weight/Reps, and select a Category.", 'error');
                return;
            }
            if (!db || !userId) {
                console.error("Firestore not initialized or user not authenticated.");
                showMessage("Application is not ready. Please try again in a moment.", 'error');
                return;
            }

            try {
                const appIdForFirestore = firebaseConfig.projectId;
                const workoutsCollectionRef = collection(db, `artifacts/${appIdForFirestore}/users/${userId}/workouts`);

                await addDoc(workoutsCollectionRef, {
                    name: name,
                    weightReps: weightReps,
                    category: category,
                    timestamp: new Date().toISOString() // Store timestamp for ordering/tracking
                });

                // Clear form inputs
                newWorkoutNameInput.value = '';
                newWorkoutWeightRepsInput.value = '';
                newWorkoutCategorySelect.value = 'chest'; // Reset to default
                showMessage("Workout added successfully!", 'success');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to add workout. Please try again.", 'error');
            }
        }

        /**
         * Deletes a workout entry from Firestore.
         * @param {string} id - The ID of the workout document to delete.
         */
        async function deleteWorkout(id) {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not authenticated.");
                showMessage("Application is not ready. Please try again in a moment.", 'error');
                return;
            }
            
            try {
                const appIdForFirestore = firebaseConfig.projectId;
                await deleteDoc(doc(db, `artifacts/${appIdForFirestore}/users/${userId}/workouts`, id));
                showMessage("Workout deleted successfully!", 'success');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("Failed to delete workout. Please try again.", 'error');
            }
        }

        // Initialize Firebase and UI elements when the window loads
        window.onload = async () => {
            // Assign UI elements to global JS variables
            newWorkoutNameInput = document.getElementById('newWorkoutName');
            newWorkoutWeightRepsInput = document.getElementById('newWorkoutWeightReps');
            newWorkoutCategorySelect = document.getElementById('newWorkoutCategory');
            addWorkoutButton = document.getElementById('addWorkoutBtn');
            workoutsListContainer = document.getElementById('workoutsList');
            userIdDisplay = document.getElementById('userIdDisplay');
            messageBox = document.getElementById('messageBox');

            // Populate category dropdown
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1); // Capitalize first letter
                newWorkoutCategorySelect.appendChild(option);
            });

            // Add event listeners
            addWorkoutButton.addEventListener('click', addWorkout);

            // --- Firebase Initialization ---
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        if (userIdDisplay) {
                            userIdDisplay.textContent = userId;
                        }
                        console.log("Authenticated with user ID:", userId);
                        listenForWorkouts(); // Start listening for workouts
                    } else {
                        // If no user (e.g., anonymous sign-in failed or not yet completed), generate a random ID
                        // This ensures a userId is always present for Firestore pathing, even for unauthenticated sessions
                        // This creates a temporary "session" for unauthenticated users.
                        let storedAnonymousId = localStorage.getItem('anonymousWorkoutUserId');
                        if (!storedAnonymousId) {
                            storedAnonymousId = crypto.randomUUID();
                            localStorage.setItem('anonymousWorkoutUserId', storedAnonymousId);
                        }
                        userId = storedAnonymousId; // Use the stored or newly generated anonymous ID
                        if (userIdDisplay) {
                            userIdDisplay.textContent = userId;
                        }
                        console.log("Signed in anonymously or using stored anonymous ID:", userId);
                        listenForWorkouts(); // Start listening for workouts
                        try {
                            await signInAnonymously(auth); // Attempt anonymous sign-in
                        } catch (error) {
                            console.error("Firebase anonymous sign-in error:", error);
                            showMessage("Could not sign in anonymously. Data might not persist.", 'error');
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showMessage("Firebase initialization failed. Check console for details.", 'error');
            }
        };
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white font-inter p-4 flex flex-col items-center">
    <div id="app-container">
        <!-- Header -->
        <header class="w-full text-center py-6">
            <h1 class="header-title text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-indigo-500 drop-shadow-lg">
                Quantum Lift Log
            </h1>
            <p class="user-id-text">
                User ID: <span id="userIdDisplay" class="font-mono text-xs break-all">Loading...</span>
            </p>
        </header>

        <!-- Add Workout Form -->
        <section class="section-card">
            <h2 class="text-2xl font-semibold mb-4 text-center text-gray-200">Log New Lift</h2>
            <div class="space-y-4">
                <input
                    type="text"
                    id="newWorkoutName"
                    placeholder="Workout Name (e.g., Deadlift)"
                />
                <input
                    type="text"
                    id="newWorkoutWeightReps"
                    placeholder="Weight x Reps (e.g., 180kg x 5)"
                />
                <select id="newWorkoutCategory" class="appearance-none">
                    <!-- Options will be dynamically populated by JavaScript -->
                </select>
                <button id="addWorkoutBtn" class="w-full primary-button">
                    Add Workout
                </button>
            </div>
        </section>

        <!-- Workout List -->
        <section class="section-card">
            <h2 class="text-2xl font-semibold mb-4 text-center text-gray-200">Your Lifts</h2>
            <div id="workoutsList" class="space-y-6">
                <!-- Workouts will be rendered here by JavaScript -->
                <p class="text-gray-400 text-center text-sm">Loading workouts...</p>
            </div>
        </section>
    </div>

    <!-- Message Box (hidden by default) -->
    <div id="messageBox" class="p-4 rounded-lg shadow-lg"></div>
</body>
</html>
