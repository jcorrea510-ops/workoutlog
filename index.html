    import React, { useState, useEffect } from 'react';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth'; // Removed signInWithCustomToken
    import { getFirestore, collection, query, addDoc, deleteDoc, doc, onSnapshot } from 'firebase/firestore';

    // Main App component for the workout tracker
    const App = () => {
        // State variables for Firebase instances and user ID
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [isAuthReady, setIsAuthReady] = useState(false); // To ensure Firebase auth is ready before operations

        // State variables for managing workout data and form inputs
        const [workouts, setWorkouts] = useState([]);
        const [newWorkoutName, setNewWorkoutName] = useState('');
        const [newWorkoutWeightReps, setNewWorkoutWeightReps] = useState('');
        const [newWorkoutCategory, setNewWorkoutCategory] = useState('chest'); // Default category

        // Categories available for workouts
        const categories = ['chest', 'tricep', 'bicep', 'back', 'shoulder', 'other'];

        // Firebase initialization and authentication effect
        useEffect(() => {
            try {
                // Your web app's Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyBigbr7vwxrPtkNRGZfUMn77It86h92G-k",
                    authDomain: "workout-log-33537.firebaseapp.com",
                    projectId: "workout-log-33537",
                    storageBucket: "workout-log-33537.firebasestorage.app",
                    messagingSenderId: "614677399114",
                    appId: "1:614677399114:web:d5ad21c1031b430a0a88b3",
                    measurementId: "G-NWH23G9N14"
                };
                
                // Initialize Firebase app
                const app = initializeApp(firebaseConfig);
                // Get Auth and Firestore instances
                const authInstance = getAuth(app);
                const dbInstance = getFirestore(app);

                setAuth(authInstance);
                setDb(dbInstance);

                // Function to handle Firebase authentication
                const initializeAuth = async () => {
                    try {
                        // Sign in anonymously for your deployed app
                        await signInAnonymously(authInstance);
                    } catch (error) {
                        console.error("Firebase authentication error:", error);
                    }
                };

                // Listen for authentication state changes
                const unsubscribeAuth = onAuthStateChanged(authInstance, (user) => {
                    if (user) {
                        setUserId(user.uid); // Set user ID if authenticated
                    } else {
                        // If no user (e.g., anonymous sign-in failed or not yet completed), generate a random ID
                        // This ensures a userId is always present for Firestore pathing, even for unauthenticated sessions
                        setUserId(crypto.randomUUID()); 
                    }
                    setIsAuthReady(true); // Mark authentication as ready
                });

                initializeAuth(); // Start authentication process

                // Cleanup function for auth listener
                return () => unsubscribeAuth();
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
            }
        }, []); // Empty dependency array means this effect runs once on mount

        // Effect for fetching and listening to workout data from Firestore
        useEffect(() => {
            // Only proceed if Firebase instances and user ID are ready
            if (!isAuthReady || !userId || !db) return;

            // For your deployed app, you can use your projectId as the appId or a fixed string.
            // The `__app_id` global variable is specific to the Canvas environment.
            const appId = "workout-log-33537"; // Using your projectId as the app identifier for Firestore pathing
            // Construct the Firestore collection reference for user-specific private data
            const workoutsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/workouts`);
            
            // Create a query for the workouts collection
            const q = query(workoutsCollectionRef);

            // Set up a real-time listener for the workouts collection
            const unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                const fetchedWorkouts = snapshot.docs.map(doc => ({
                    id: doc.id, // Document ID is essential for deletion
                    ...doc.data() // All other document data
                }));

                // Sort workouts client-side by category and then by name for consistent display
                fetchedWorkouts.sort((a, b) => {
                    const categoryOrder = ['chest', 'tricep', 'bicep', 'back', 'shoulder', 'other'];
                    const categoryA = categoryOrder.indexOf(a.category);
                    const categoryB = categoryOrder.indexOf(b.category);

                    if (categoryA !== categoryB) {
                        return categoryA - categoryB; // Sort by category order
                    }
                    return a.name.localeCompare(b.name); // Then by workout name alphabetically
                });
                setWorkouts(fetchedWorkouts); // Update the workouts state
            }, (error) => {
                console.error("Error fetching workouts:", error);
                // In a production app, you might show a user-friendly error message here
            });

            // Cleanup function for the snapshot listener
            return () => unsubscribeSnapshot();
        }, [isAuthReady, userId, db]); // Re-run when auth state, user ID, or db instance changes

        // Function to add a new workout to Firestore
        const addWorkout = async () => {
            // Basic validation for form inputs
            if (!newWorkoutName.trim() || !newWorkoutWeightReps.trim() || !newWorkoutCategory) {
                // Using a simple alert for now, but in a real app, use a custom modal
                alert("Please fill all fields: Workout Name, Weight/Reps, and select a Category.");
                return;
            }
            if (!db || !userId) {
                console.error("Firestore not initialized or user not authenticated.");
                alert("Application is not ready. Please try again in a moment.");
                return;
            }

            try {
                // For your deployed app, you can use your projectId as the appId or a fixed string.
                const appId = "workout-log-33537"; // Using your projectId as the app identifier for Firestore pathing
                const workoutsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/workouts`);

                // Add a new document to the 'workouts' collection
                await addDoc(workoutsCollectionRef, {
                    name: newWorkoutName.trim(),
                    weightReps: newWorkoutWeightReps.trim(),
                    category: newWorkoutCategory,
                    timestamp: new Date().toISOString() // Store timestamp for ordering/tracking
                });

                // Clear form inputs after successful addition
                setNewWorkoutName('');
                setNewWorkoutWeightReps('');
                setNewWorkoutCategory('chest'); // Reset to default category
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Failed to add workout. Please try again.");
            }
        };

        // Function to delete a workout from Firestore
        const deleteWorkout = async (id) => {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not authenticated.");
                alert("Application is not ready. Please try again in a moment.");
                return;
            }
            
            try {
                // For your deployed app, you can use your projectId as the appId or a fixed string.
                const appId = "workout-log-33537"; // Using your projectId as the app identifier for Firestore pathing
                // Construct the document reference for the specific workout to delete
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/workouts`, id));
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert("Failed to delete workout. Please try again.");
            }
        };

        // Group workouts by category for display
        const groupedWorkouts = categories.reduce((acc, category) => {
            acc[category] = workouts.filter(workout => workout.category === category);
            return acc;
        }, {});

        return (
            <div className="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-white font-inter p-4 flex flex-col items-center">
                {/* Header */}
                <header className="w-full max-w-md text-center py-6">
                    <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 drop-shadow-lg">
                        Lift Tracker
                    </h1>
                    {userId && (
                        <p className="text-sm text-gray-400 mt-2">
                            User ID: <span className="font-mono text-xs break-all">{userId}</span>
                        </p>
                    )}
                </header>

                {/* Add Workout Form */}
                <section className="w-full max-w-md bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
                    <h2 className="text-2xl font-semibold mb-4 text-center text-gray-200">Add New Lift</h2>
                    <div className="space-y-4">
                        <input
                            type="text"
                            placeholder="Workout Name (e.g., Incline Chest Press)"
                            value={newWorkoutName}
                            onChange={(e) => setNewWorkoutName(e.target.value)}
                            className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <input
                            type="text"
                            placeholder="Weight x Reps (e.g., 40x5)"
                            value={newWorkoutWeightReps}
                            onChange={(e) => setNewWorkoutWeightReps(e.target.value)}
                            className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <select
                            value={newWorkoutCategory}
                            onChange={(e) => setNewWorkoutCategory(e.target.value)}
                            className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none"
                        >
                            {categories.map(category => (
                                <option key={category} value={category} className="capitalize">
                                    {category}
                                </option>
                            ))}
                        </select>
                        <button
                            onClick={addWorkout}
                            className="w-full bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition-transform duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800"
                        >
                            Add Workout
                        </button>
                    </div>
                </section>

                {/* Workout List */}
                <section className="w-full max-w-md bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 className="text-2xl font-semibold mb-4 text-center text-gray-200">Your Lifts</h2>
                    {workouts.length === 0 && (
                        <p className="text-gray-400 text-center">No workouts added yet. Start lifting!</p>
                    )}

                    {categories.map(category => (
                        groupedWorkouts[category].length > 0 && (
                            <div key={category} className="mb-6">
                                <h3 className="text-xl font-bold text-purple-400 capitalize mb-3 border-b border-gray-700 pb-2">
                                    {category}
                                </h3>
                                <ul className="space-y-3">
                                    {groupedWorkouts[category].map(workout => (
                                        <li
                                            key={workout.id}
                                            className="flex items-center justify-between bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600"
                                        >
                                            <div>
                                                <p className="text-lg font-medium text-gray-100">{workout.name}</p>
                                                <p className="text-md text-gray-300">{workout.weightReps}</p>
                                            </div>
                                            <button
                                                onClick={() => deleteWorkout(workout.id)}
                                                className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-full shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-700"
                                                aria-label="Delete workout"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
                                                </svg>
                                            </button>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )
                    ))}
                </section>
            </div>
        );
    };

    export default App;
    